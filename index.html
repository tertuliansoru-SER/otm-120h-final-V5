<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTM 120H V5.5 - Sistema de Monitoreo Industrial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500;800&display=swap');
        
        :root {
            --fuego: #f97316;
            --gases: #3b82f6;
            --bg: #050505;
            --panel: #111111;
        }

        body {
            background-color: var(--bg);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .panel-industrial {
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .ti-display {
            font-size: 10rem;
            line-height: 1;
            font-weight: 900;
            color: var(--fuego);
            text-shadow: 0 0 30px rgba(249, 115, 22, 0.3);
        }

        .br칰jula-giro {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .bg-fuego { background-color: var(--fuego); }
        .bg-gases { background-color: var(--gases); }

        /* Estilos para ocultar flechas de inputs */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #000; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        #lock-screen {
            background: radial-gradient(circle, #111 0%, #000 100%);
        }
    </style>
</head>
<body class="p-4 lg:p-6">

    <!-- PANTALLA DE BLOQUEO (SEGURIDAD PIN 1407) -->
    <div id="lock-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="panel-industrial p-10 rounded-[3rem] text-center max-w-sm w-full border border-white/10">
            <h2 class="text-xl font-black uppercase tracking-widest mb-6">Seguridad OTM</h2>
            <input type="password" id="pin-input" placeholder="****" maxlength="4" class="w-full bg-black border border-zinc-800 p-4 rounded-2xl text-center text-5xl font-black text-fuego outline-none mb-6 tracking-[0.5em]">
            <button onclick="checkPIN()" class="w-full bg-orange-600 hover:bg-orange-500 py-4 rounded-2xl font-black uppercase tracking-widest transition-all">Desbloquear</button>
            <p class="mt-6 text-[10px] text-zinc-600 uppercase font-bold tracking-tighter">Acceso restringido a personal de ingenier칤a</p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-main" class="hidden max-w-[1600px] mx-auto space-y-6">
        
        <!-- HEADER INDUSTRIAL -->
        <header class="panel-industrial p-6 rounded-[2.5rem] flex flex-wrap items-center justify-between gap-6">
            <div class="flex items-center gap-5">
                <div class="bg-fuego p-4 rounded-3xl shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase">OTM 120H <span class="text-fuego">V5.5</span></h1>
                    <div class="flex gap-4 mt-2">
                        <input type="text" id="op_name" placeholder="OPERADOR" class="bg-transparent border-b border-zinc-800 text-[10px] font-black uppercase outline-none focus:border-fuego w-32 pb-1">
                        <input type="text" id="op_punta" placeholder="PUNTA" class="bg-transparent border-b border-zinc-800 text-[10px] font-black uppercase outline-none focus:border-fuego w-24 pb-1">
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-8">
                <div class="text-right">
                    <p class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">Reloj Maestro Curado</p>
                    <div id="master-clock" class="text-4xl font-black mono text-white tracking-tighter">000:00:00</div>
                </div>
                <div class="flex items-center gap-2 px-4 py-2 bg-black rounded-2xl border border-white/5">
                    <div id="sync-dot" class="status-dot bg-emerald-500"></div>
                    <span id="sync-text" class="text-[9px] font-black text-emerald-500 uppercase">Sincronizado</span>
                </div>
                <button id="btn-master" onclick="toggleClock()" class="bg-gases px-6 py-3 rounded-2xl font-black text-xs uppercase tracking-widest hover:opacity-80 transition-all">Iniciar</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- PANEL IZQUIERDO: BR칔JULAS Y FASES -->
            <div class="lg:col-span-3 space-y-6">
                <!-- BR칔JULA DE FASE ACTUAL -->
                <section class="panel-industrial p-6 rounded-[2.5rem] border-l-8 border-fuego space-y-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 id="phase-label" class="text-fuego text-xs font-black uppercase tracking-widest italic">Br칰jula de Fase 1</h2>
                        <span id="freq-indicator" class="px-2 py-1 rounded bg-emerald-500/10 text-emerald-500 text-[9px] font-black">游릭 NORMAL</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                            <span class="text-[9px] font-bold text-zinc-500 uppercase">Temp Meta</span>
                            <span id="target-temp" class="text-xs font-black text-white">120 - 150춿C</span>
                        </div>
                        <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                            <span class="text-[9px] font-bold text-zinc-500 uppercase">Draft Ideal</span>
                            <span id="target-draft" class="text-xs font-black text-gases">-1.0 / -2.5</span>
                        </div>
                        <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                            <span class="text-[9px] font-bold text-zinc-500 uppercase">Frecuencia</span>
                            <span id="target-freq" class="text-xs font-black text-white">30 min</span>
                        </div>
                    </div>
                </section>

                <!-- BR칔JULA DE GIRO -->
                <section id="rotation-card" class="panel-industrial p-8 rounded-[2.5rem] text-center relative overflow-hidden">
                    <p class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-6">Posici칩n del Horno (90춿)</p>
                    <div class="relative w-36 h-36 mx-auto bg-black rounded-full border-4 border-zinc-900 flex items-center justify-center">
                        <div id="compass-dial" class="absolute inset-0 br칰jula-giro flex items-center justify-center">
                            <div class="w-1 h-16 bg-gradient-to-t from-fuego to-transparent rounded-full relative">
                                <div class="absolute -top-1 left-1/2 -translate-x-1/2 w-4 h-4 bg-fuego rounded-full border-4 border-black"></div>
                            </div>
                        </div>
                        <div class="text-[9px] font-black text-zinc-800 absolute top-2">NORTE</div>
                        <div id="giro-text" class="text-xl font-black mono text-zinc-400 z-10">0춿</div>
                    </div>
                    <div id="rotation-timer" class="text-4xl font-black mono text-gases mt-6">60:00</div>
                    <button onclick="confirmRotation()" class="w-full mt-6 bg-white/5 hover:bg-white/10 border border-white/10 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Confirmar Giro</button>
                </section>
            </div>

            <!-- PANEL CENTRAL: MONITOR Y MEDICI칍N -->
            <div class="lg:col-span-6 space-y-6">
                <!-- MONITOR DOMINANTE -->
                <section class="panel-industrial p-10 rounded-[3.5rem] text-center border-t-8 border-fuego relative">
                    <p class="text-[11px] font-black text-zinc-500 uppercase tracking-[0.3em] mb-4 italic">Temperatura Interna Proyectada ($T_i$)</p>
                    <div id="main-ti" class="ti-display tracking-tighter">0<span class="text-4xl ml-2 font-black text-zinc-800 italic">춿C</span></div>
                    
                    <div class="flex justify-center gap-4 mt-8">
                        <div id="mode-badge" class="px-4 py-1.5 bg-fuego text-white text-[10px] font-black rounded-full uppercase">Modo: Termocupla</div>
                        <div id="ratio-badge" class="px-4 py-1.5 bg-zinc-900 border border-white/10 text-fuego text-[10px] font-black rounded-full mono italic">Relaci칩n: 3.50x</div>
                    </div>
                </section>

                <!-- ENTRADA DIN츼MICA -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <section class="panel-industrial p-8 rounded-[2.5rem]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xs font-black text-zinc-500 uppercase tracking-widest">Captura T칠rmica</h3>
                            <button onclick="switchMode()" class="text-[9px] font-black bg-zinc-800 hover:bg-zinc-700 px-3 py-1 rounded-lg transition-all uppercase">Cambiar Sensor</button>
                        </div>
                        <div id="inputs-box" class="space-y-4">
                            <!-- Inyecci칩n din치mica JS -->
                        </div>
                    </section>

                    <section class="panel-industrial p-8 rounded-[2.5rem] flex flex-col justify-between border-l-4 border-gases">
                        <div>
                            <h3 class="text-xs font-black text-gases uppercase tracking-widest mb-6 italic">Din치mica de Gases</h3>
                            <div class="bg-black p-6 rounded-3xl text-center border border-white/5">
                                <label class="text-[10px] font-black text-gases uppercase block mb-4">Pitot (mmca)</label>
                                <input type="number" id="in-draft" step="0.1" class="bg-transparent text-6xl font-black text-white w-full text-center outline-none mono" placeholder="0.0" oninput="process()">
                            </div>
                        </div>
                        <button onclick="saveRecord()" class="w-full mt-6 bg-fuego py-6 rounded-3xl font-black uppercase text-sm tracking-[0.2em] shadow-2xl hover:brightness-110 active:scale-95 transition-all">
                            Grabar Punto de Control
                        </button>
                    </section>
                </div>

                <!-- ALERTAS IA MONITOR -->
                <section class="panel-industrial p-6 rounded-[2.5rem] border border-blue-500/20 bg-blue-500/5">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-2 h-2 bg-gases rounded-full animate-ping"></div>
                        <span class="text-[10px] font-black text-gases uppercase tracking-widest">IA Monitor: An치lisis de Seguridad</span>
                    </div>
                    <div id="ia-console" class="text-xs font-bold text-zinc-400 italic space-y-2">
                        Esperando sincronizaci칩n de datos operativos...
                    </div>
                </section>
            </div>

            <!-- PANEL DERECHO: BIT츼CORA -->
            <div class="lg:col-span-3">
                <section class="panel-industrial h-full rounded-[2.5rem] flex flex-col overflow-hidden">
                    <div class="p-5 border-b border-white/5 bg-white/5 flex justify-between items-center">
                        <span class="text-[10px] font-black text-zinc-500 uppercase italic">Bit치cora T칠cnica</span>
                        <button onclick="exportCSV()" class="text-[9px] font-bold text-gases hover:underline">EXPORTAR CSV</button>
                    </div>
                    <div id="log-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll font-mono text-[9px]">
                        <!-- Entradas de bit치cora -->
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- AUDIO BEEP (GENERADO POR SINTESIS) -->
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = "sine";
            osc.frequency.value = 880;
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }
    </script>

    <script>
        // --- CONSTANTES DE INGENIER칈A ---
        const PIN_ACCESO = "1407";
        const RATIO = 3.5;
        const LIMITE_BANANA_WARN = 80;
        const LIMITE_BANANA_CRIT = 120;
        const LIMITE_SALTO = 40; // 춿C en 10 min

        // --- ESTADO DEL SISTEMA ---
        let state = {
            active: false,
            mode: 'TC', // 'TC' o 'LASER'
            seconds: parseInt(localStorage.getItem('otm_55_sec')) || 0,
            phase: 1,
            rotSeconds: 0,
            giroDeg: 0,
            freqMode: 'NORMAL', // 'NORMAL' o 'INTENSIVE'
            stableCount: 0,
            lastSaveTime: 0,
            lastTi: 0,
            logs: JSON.parse(localStorage.getItem('otm_55_logs')) || []
        };

        const FASES = {
            1: { name: "Fase 1: Deshidrataci칩n", h: 24, temp: [120, 150], draft: [-1.0, -2.5], rot: 60, freq: 30 },
            2: { name: "Fase 2: Calentamiento", h: 72, temp: [320, 350], draft: [-1.2, -2.5], rot: 30, freq: 30 },
            3: { name: "Fase 3: Curado Final", h: 120, temp: [600, 650], draft: [-1.5, -2.5], rot: 15, freq: 30 }
        };

        // --- SEGURIDAD ---
        function checkPIN() {
            const input = document.getElementById('pin-input').value;
            if (input === PIN_ACCESO) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-main').style.display = 'block';
                init();
            } else {
                state.logs.unshift({h: 'SECURITY', op: 'FAIL', ti: 'PIN', mode: 'ALERT', draft: '0'});
                saveToLocal();
                alert("Acceso Denegado. Intento registrado.");
            }
        }

        function init() {
            document.getElementById('op_name').value = localStorage.getItem('otm_55_op') || '';
            document.getElementById('op_punta').value = localStorage.getItem('otm_55_punta') || '';
            renderInputs();
            renderLogs();
            setInterval(tick, 1000);
        }

        // --- MOTOR DE TIEMPO ---
        function toggleClock() {
            state.active = !state.active;
            const btn = document.getElementById('btn-master');
            btn.innerText = state.active ? "Pausar" : "Reanudar";
            btn.className = state.active ? "bg-red-600 px-6 py-3 rounded-2xl font-black text-xs uppercase" : "bg-gases px-6 py-3 rounded-2xl font-black text-xs uppercase";
        }

        function tick() {
            if (!state.active) return;

            state.seconds++;
            saveToLocal();

            // L칩gica de Fases
            const hours = state.seconds / 3600;
            let p = 1;
            if (hours >= 24) p = 2;
            if (hours >= 72) p = 3;
            if (p !== state.phase) {
                state.phase = p;
                confirmRotation(); // Reset rotaci칩n al cambiar fase
            }

            // L칩gica de Giro
            if (state.rotSeconds > 0) {
                state.rotSeconds--;
            } else {
                document.getElementById('rotation-card').classList.add('alert-active');
                if (state.seconds % 60 === 0) beep();
            }

            updateUI();
            process();
        }

        // --- UI & INTERACCI칍N ---
        function updateUI() {
            const h = Math.floor(state.seconds / 3600).toString().padStart(3, '0');
            const m = Math.floor((state.seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (state.seconds % 60).toString().padStart(2, '0');
            document.getElementById('master-clock').innerText = `${h}:${m}:${s}`;

            const f = FASES[state.phase];
            document.getElementById('phase-label').innerText = `Br칰jula de ${f.name}`;
            document.getElementById('target-temp').innerText = `${f.temp[0]} - ${f.temp[1]}춿C`;
            document.getElementById('target-draft').innerText = `${f.draft[0].toFixed(1)} / ${f.draft[1].toFixed(1)}`;
            
            // Frecuencia Inteligente UI
            const freqVal = (state.phase === 1 && hours() < 6) ? 15 : f.freq;
            document.getElementById('target-freq').innerText = state.freqMode === 'INTENSIVE' ? '15 min (Intensivo)' : `${freqVal} min`;
            
            const freqInd = document.getElementById('freq-indicator');
            if (state.freqMode === 'INTENSIVE') {
                freqInd.innerText = "游리 INTENSIVO";
                freqInd.className = "px-2 py-1 rounded bg-orange-500/10 text-orange-500 text-[9px] font-black";
            } else {
                freqInd.innerText = "游릭 NORMAL";
                freqInd.className = "px-2 py-1 rounded bg-emerald-500/10 text-emerald-500 text-[9px] font-black";
            }

            const rm = Math.floor(state.rotSeconds / 60).toString().padStart(2, '0');
            const rs = (state.rotSeconds % 60).toString().padStart(2, '0');
            document.getElementById('rotation-timer').innerText = `${rm}:${rs}`;
        }

        function renderInputs() {
            const box = document.getElementById('inputs-box');
            if (state.mode === 'TC') {
                box.innerHTML = `
                    <div class="bg-black/50 p-6 rounded-2xl border border-white/5 shadow-inner">
                        <label class="text-[9px] font-black text-zinc-600 uppercase block mb-2 tracking-widest">Termocupla Directa (Ti)</label>
                        <input type="number" id="in-tc" class="w-full bg-transparent text-5xl font-black text-fuego outline-none mono" placeholder="000" oninput="process()">
                    </div>`;
            } else {
                box.innerHTML = `
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-black/40 p-3 rounded-2xl text-center"><span class="text-[8px] font-bold text-zinc-600 uppercase">L1 Carga</span><input type="number" id="l1" class="w-full bg-transparent text-center font-black text-xl outline-none" oninput="process()"></div>
           