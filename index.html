<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTM 120H V5.5 - Sistema de Monitoreo Industrial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500;800&display=swap');
        
        :root {
            --fuego: #f97316;
            --gases: #3b82f6;
            --bg: #050505;
            --panel: #111111;
        }

        body {
            background-color: var(--bg);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .panel-industrial {
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .ti-display {
            font-size: 10rem;
            line-height: 1;
            font-weight: 900;
            color: var(--fuego);
            text-shadow: 0 0 30px rgba(249, 115, 22, 0.3);
        }

        .br√∫jula-giro {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .bg-fuego { background-color: var(--fuego); }
        .bg-gases { background-color: var(--gases); }

        /* Estilos para ocultar flechas de inputs */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #000; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        #lock-screen {
            background: radial-gradient(circle, #111 0%, #000 100%);
        }
    </style>
</head>
<body class="p-4 lg:p-6">

    <!-- PANTALLA DE BLOQUEO (SEGURIDAD PIN 1407) -->
    <div id="lock-screen" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="panel-industrial p-10 rounded-[3rem] text-center max-w-sm w-full border border-white/10">
            <h2 class="text-xl font-black uppercase tracking-widest mb-6">Seguridad OTM</h2>
            <input type="password" id="pin-input" placeholder="****" maxlength="4" class="w-full bg-black border border-zinc-800 p-4 rounded-2xl text-center text-5xl font-black text-fuego outline-none mb-6 tracking-[0.5em]">
            <button onclick="checkPIN()" class="w-full bg-orange-600 hover:bg-orange-500 py-4 rounded-2xl font-black uppercase tracking-widest transition-all">Desbloquear</button>
            <p class="mt-6 text-[10px] text-zinc-600 uppercase font-bold tracking-tighter">Acceso restringido a personal de ingenier√≠a</p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-main" class="hidden max-w-[1600px] mx-auto space-y-6">
        
        <!-- HEADER INDUSTRIAL -->
        <header class="panel-industrial p-6 rounded-[2.5rem] flex flex-wrap items-center justify-between gap-6">
            <div class="flex items-center gap-5">
                <div class="bg-fuego p-4 rounded-3xl shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase">OTM 120H <span class="text-fuego">V5.5</span></h1>
                    <div class="flex gap-4 mt-2">
                        <input type="text" id="op_name" placeholder="OPERADOR" class="bg-transparent border-b border-zinc-800 text-[10px] font-black uppercase outline-none focus:border-fuego w-32 pb-1">
                        <input type="text" id="op_punta" placeholder="PUNTA" class="bg-transparent border-b border-zinc-800 text-[10px] font-black uppercase outline-none focus:border-fuego w-24 pb-1">
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-8">
                <div class="text-right">
                    <p class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">Reloj Maestro Curado</p>
                    <div id="master-clock" class="text-4xl font-black mono text-white tracking-tighter">000:00:00</div>
                </div>
                <div class="flex items-center gap-2 px-4 py-2 bg-black rounded-2xl border border-white/5">
                    <div id="sync-dot" class="status-dot bg-emerald-500"></div>
                    <span id="sync-text" class="text-[9px] font-black text-emerald-500 uppercase">Sincronizado</span>
                </div>
                <button id="btn-master" onclick="toggleClock()" class="bg-gases px-6 py-3 rounded-2xl font-black text-xs uppercase tracking-widest hover:opacity-80 transition-all">Iniciar</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- PANEL IZQUIERDO: BR√öJULAS Y FASES -->
            <div class="lg:col-span-3 space-y-6">
                <!-- BR√öJULA DE FASE ACTUAL -->
                <section class="panel-industrial p-6 rounded-[2.5rem] border-l-8 border-fuego space-y-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 id="phase-label" class="text-fuego text-xs font-black uppercase tracking-widest italic">Br√∫jula de Fase 1</h2>
                        <span id="freq-indicator" class="px-2 py-1 rounded bg-emerald-500/10 text-emerald-500 text-[9px] font-black">üü¢ NORMAL</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                            <span class="text-[9px] font-bold text-zinc-500 uppercase">Temp Meta</span>
                            <span id="target-temp" class="text-xs font-black text-white">120 - 150¬∞C</span>
                        </div>
                        <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                            <span class="text-[9px] font-bold text-zinc-500 uppercase">Draft Ideal</span>
                            <span id="target-draft" class="text-xs font-black text-gases">-1.0 / -2.5</span>
                        </div>
                        <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                            <span class="text-[9px] font-bold text-zinc-500 uppercase">Frecuencia</span>
                            <span id="target-freq" class="text-xs font-black text-white">30 min</span>
                        </div>
                    </div>
                </section>

                <!-- BR√öJULA DE GIRO -->
                <section id="rotation-card" class="panel-industrial p-8 rounded-[2.5rem] text-center relative overflow-hidden">
                    <p class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-6">Posici√≥n del Horno (90¬∞)</p>
                    <div class="relative w-36 h-36 mx-auto bg-black rounded-full border-4 border-zinc-900 flex items-center justify-center">
                        <div id="compass-dial" class="absolute inset-0 br√∫jula-giro flex items-center justify-center">
                            <div class="w-1 h-16 bg-gradient-to-t from-fuego to-transparent rounded-full relative">
                                <div class="absolute -top-1 left-1/2 -translate-x-1/2 w-4 h-4 bg-fuego rounded-full border-4 border-black"></div>
                            </div>
                        </div>
                        <div class="text-[9px] font-black text-zinc-800 absolute top-2">NORTE</div>
                        <div id="giro-text" class="text-xl font-black mono text-zinc-400 z-10">0¬∞</div>
                    </div>
                    <div id="rotation-timer" class="text-4xl font-black mono text-gases mt-6">60:00</div>
                    <button onclick="confirmRotation()" class="w-full mt-6 bg-white/5 hover:bg-white/10 border border-white/10 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">Confirmar Giro</button>
                </section>
            </div>

            <!-- PANEL CENTRAL: MONITOR Y MEDICI√ìN -->
            <div class="lg:col-span-6 space-y-6">
                <!-- MONITOR DOMINANTE -->
                <section class="panel-industrial p-10 rounded-[3.5rem] text-center border-t-8 border-fuego relative">
                    <p class="text-[11px] font-black text-zinc-500 uppercase tracking-[0.3em] mb-4 italic">Temperatura Interna Proyectada ($T_i$)</p>
                    <div id="main-ti" class="ti-display tracking-tighter">0<span class="text-4xl ml-2 font-black text-zinc-800 italic">¬∞C</span></div>
                    
                    <div class="flex justify-center gap-4 mt-8">
                        <div id="mode-badge" class="px-4 py-1.5 bg-fuego text-white text-[10px] font-black rounded-full uppercase">Modo: Termocupla</div>
                        <div id="ratio-badge" class="px-4 py-1.5 bg-zinc-900 border border-white/10 text-fuego text-[10px] font-black rounded-full mono italic">Relaci√≥n: 3.50x</div>
                    </div>
                </section>

                <!-- ENTRADA DIN√ÅMICA -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <section class="panel-industrial p-8 rounded-[2.5rem]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xs font-black text-zinc-500 uppercase tracking-widest">Captura T√©rmica</h3>
                            <button onclick="switchMode()" class="text-[9px] font-black bg-zinc-800 hover:bg-zinc-700 px-3 py-1 rounded-lg transition-all uppercase">Cambiar Sensor</button>
                        </div>
                        <div id="inputs-box" class="space-y-4">
                            <!-- Inyecci√≥n din√°mica JS -->
                        </div>
                    </section>

                    <section class="panel-industrial p-8 rounded-[2.5rem] flex flex-col justify-between border-l-4 border-gases">
                        <div>
                            <h3 class="text-xs font-black text-gases uppercase tracking-widest mb-6 italic">Din√°mica de Gases</h3>
                            <div class="bg-black p-6 rounded-3xl text-center border border-white/5">
                                <label class="text-[10px] font-black text-gases uppercase block mb-4">Pitot (mmca)</label>
                                <input type="number" id="in-draft" step="0.1" class="bg-transparent text-6xl font-black text-white w-full text-center outline-none mono" placeholder="0.0" oninput="process()">
                            </div>
                        </div>
                        <button onclick="saveRecord()" class="w-full mt-6 bg-fuego py-6 rounded-3xl font-black uppercase text-sm tracking-[0.2em] shadow-2xl hover:brightness-110 active:scale-95 transition-all">
                            Grabar Punto de Control
                        </button>
                    </section>
                </div>

                <!-- ALERTAS IA MONITOR -->
                <section class="panel-industrial p-6 rounded-[2.5rem] border border-blue-500/20 bg-blue-500/5">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-2 h-2 bg-gases rounded-full animate-ping"></div>
                        <span class="text-[10px] font-black text-gases uppercase tracking-widest">IA Monitor: An√°lisis de Seguridad</span>
                    </div>
                    <div id="ia-console" class="text-xs font-bold text-zinc-400 italic space-y-2">
                        Esperando sincronizaci√≥n de datos operativos...
                    </div>
                </section>
            </div>

            <!-- PANEL DERECHO: BIT√ÅCORA -->
            <div class="lg:col-span-3">
                <section class="panel-industrial h-full rounded-[2.5rem] flex flex-col overflow-hidden">
                    <div class="p-5 border-b border-white/5 bg-white/5 flex justify-between items-center">
                        <span class="text-[10px] font-black text-zinc-500 uppercase italic">Bit√°cora T√©cnica</span>
                        <button onclick="exportCSV()" class="text-[9px] font-bold text-gases hover:underline">EXPORTAR CSV</button>
                    </div>
                    <div id="log-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll font-mono text-[9px]">
                        <!-- Entradas de bit√°cora -->
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- AUDIO BEEP (GENERADO POR SINTESIS) -->
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = "sine";
            osc.frequency.value = 880;
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }
    </script>

    <script>
        // --- CONSTANTES DE INGENIER√çA ---
        const PIN_ACCESO = "1407";
        const RATIO = 3.5;
        const LIMITE_BANANA_WARN = 80;
        const LIMITE_BANANA_CRIT = 120;
        const LIMITE_SALTO = 40; // ¬∞C en 10 min

        // --- ESTADO DEL SISTEMA ---
        let state = {
            active: false,
            mode: 'TC', // 'TC' o 'LASER'
            seconds: parseInt(localStorage.getItem('otm_55_sec')) || 0,
            phase: 1,
            rotSeconds: 0,
            giroDeg: 0,
            freqMode: 'NORMAL', // 'NORMAL' o 'INTENSIVE'
            stableCount: 0,
            lastSaveTime: 0,
            lastTi: 0,
            logs: JSON.parse(localStorage.getItem('otm_55_logs')) || []
        };

        const FASES = {
            1: { name: "Fase 1: Deshidrataci√≥n", h: 24, temp: [120, 150], draft: [-1.0, -2.5], rot: 60, freq: 30 },
            2: { name: "Fase 2: Calentamiento", h: 72, temp: [320, 350], draft: [-1.2, -2.5], rot: 30, freq: 30 },
            3: { name: "Fase 3: Curado Final", h: 120, temp: [600, 650], draft: [-1.5, -2.5], rot: 15, freq: 30 }
        };

        // --- SEGURIDAD ---
        function checkPIN() {
            const input = document.getElementById('pin-input').value;
            if (input === PIN_ACCESO) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-main').style.display = 'block';
                init();
            } else {
                state.logs.unshift({h: 'SECURITY', op: 'FAIL', ti: 'PIN', mode: 'ALERT', draft: '0'});
                saveToLocal();
                alert("Acceso Denegado. Intento registrado.");
            }
        }

        function init() {
            document.getElementById('op_name').value = localStorage.getItem('otm_55_op') || '';
            document.getElementById('op_punta').value = localStorage.getItem('otm_55_punta') || '';
            renderInputs();
            renderLogs();
            setInterval(tick, 1000);
        }

        // --- MOTOR DE TIEMPO ---
        function toggleClock() {
            state.active = !state.active;
            const btn = document.getElementById('btn-master');
            btn.innerText = state.active ? "Pausar" : "Reanudar";
            btn.className = state.active ? "bg-red-600 px-6 py-3 rounded-2xl font-black text-xs uppercase" : "bg-gases px-6 py-3 rounded-2xl font-black text-xs uppercase";
        }

        function tick() {
            if (!state.active) return;

            state.seconds++;
            saveToLocal();

            // L√≥gica de Fases
            const hours = state.seconds / 3600;
            let p = 1;
            if (hours >= 24) p = 2;
            if (hours >= 72) p = 3;
            if (p !== state.phase) {
                state.phase = p;
                confirmRotation(); // Reset rotaci√≥n al cambiar fase
            }

            // L√≥gica de Giro
            if (state.rotSeconds > 0) {
                state.rotSeconds--;
            } else {
                document.getElementById('rotation-card').classList.add('alert-active');
                if (state.seconds % 60 === 0) beep();
            }

            updateUI();
            process();
        }

        // --- UI & INTERACCI√ìN ---
        function updateUI() {
            const h = Math.floor(state.seconds / 3600).toString().padStart(3, '0');
            const m = Math.floor((state.seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (state.seconds % 60).toString().padStart(2, '0');
            document.getElementById('master-clock').innerText = `${h}:${m}:${s}`;

            const f = FASES[state.phase];
            document.getElementById('phase-label').innerText = `Br√∫jula de ${f.name}`;
            document.getElementById('target-temp').innerText = `${f.temp[0]} - ${f.temp[1]}¬∞C`;
            document.getElementById('target-draft').innerText = `${f.draft[0].toFixed(1)} / ${f.draft[1].toFixed(1)}`;
            
            // Frecuencia Inteligente UI
            const freqVal = (state.phase === 1 && hours() < 6) ? 15 : f.freq;
            document.getElementById('target-freq').innerText = state.freqMode === 'INTENSIVE' ? '15 min (Intensivo)' : `${freqVal} min`;
            
            const freqInd = document.getElementById('freq-indicator');
            if (state.freqMode === 'INTENSIVE') {
                freqInd.innerText = "üü° INTENSIVO";
                freqInd.className = "px-2 py-1 rounded bg-orange-500/10 text-orange-500 text-[9px] font-black";
            } else {
                freqInd.innerText = "üü¢ NORMAL";
                freqInd.className = "px-2 py-1 rounded bg-emerald-500/10 text-emerald-500 text-[9px] font-black";
            }

            const rm = Math.floor(state.rotSeconds / 60).toString().padStart(2, '0');
            const rs = (state.rotSeconds % 60).toString().padStart(2, '0');
            document.getElementById('rotation-timer').innerText = `${rm}:${rs}`;
        }

        function renderInputs() {
            const box = document.getElementById('inputs-box');
            if (state.mode === 'TC') {
                box.innerHTML = `
                    <div class="bg-black/50 p-6 rounded-2xl border border-white/5 shadow-inner">
                        <label class="text-[9px] font-black text-zinc-600 uppercase block mb-2 tracking-widest">Termocupla Directa (Ti)</label>
                        <input type="number" id="in-tc" class="w-full bg-transparent text-5xl font-black text-fuego outline-none mono" placeholder="000" oninput="process()">
                    </div>`;
            } else {
                box.innerHTML = `
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-black/40 p-3 rounded-2xl text-center"><span class="text-[8px] font-bold text-zinc-600 uppercase">L1 Carga</span><input type="number" id="l1" class="w-full bg-transparent text-center font-black text-xl outline-none" oninput="process()"></div>
                        <div class="bg-black/40 p-3 rounded-2xl text-center"><span class="text-[8px] font-bold text-zinc-600 uppercase">L2 Centro</span><input type="number" id="l2" class="w-full bg-transparent text-center font-black text-xl outline-none" oninput="process()"></div>
                        <div class="bg-black/40 p-3 rounded-2xl text-center"><span class="text-[8px] font-bold text-zinc-600 uppercase">L3 Desc.</span><input type="number" id="l3" class="w-full bg-transparent text-center font-black text-xl outline-none" oninput="process()"></div>
                    </div>
                    <div class="flex justify-between items-center px-4 py-2 bg-fuego/5 rounded-xl border border-fuego/10">
                        <span class="text-[9px] font-black text-fuego uppercase tracking-widest">Promedio Casco (Te)</span>
                        <span id="te-avg" class="text-xl font-black mono text-fuego">0.0¬∞C</span>
                    </div>`;
            }
        }

        function switchMode() {
            state.mode = state.mode === 'TC' ? 'Laser' : 'TC';
            document.getElementById('mode-badge').innerText = `Modo: ${state.mode === 'TC' ? 'Termocupla' : 'Pistola L√°ser'}`;
            renderInputs();
            process();
        }

        // --- PROCESAMIENTO T√âRMICO ---
        function process() {
            const inTc = document.getElementById('in-tc')?.value || 0;
            const l1 = parseFloat(document.getElementById('l1')?.value) || 0;
            const l2 = parseFloat(document.getElementById('l2')?.value) || 0;
            const l3 = parseFloat(document.getElementById('l3')?.value) || 0;
            const draft = document.getElementById('in-draft').value === "" ? null : parseFloat(document.getElementById('in-draft').value);

            let ti = 0;
            let te = 0;
            let deltaAxial = 0;

            if (state.mode === 'TC') {
                ti = parseFloat(inTc);
            } else {
                const casco = [l1, l2, l3].filter(v => v > 0);
                te = casco.length ? casco.reduce((a,b)=>a+b,0)/casco.length : 0;
                ti = te * RATIO;
                deltaAxial = casco.length ? Math.max(...casco) - Math.min(...casco) : 0;
                if(document.getElementById('te-avg')) document.getElementById('te-avg').innerText = te.toFixed(1) + "¬∞C";
            }

            document.getElementById('main-ti').innerHTML = `${Math.round(ti)}<span class="text-4xl ml-2 font-black text-zinc-800 italic">¬∞C</span>`;
            
            // IA MONITOR
            const console = document.getElementById('ia-console');
            console.innerHTML = "";
            const f = FASES[state.phase];
            let intensiveTrigger = false;

            // 1. Alerta Banana
            if (deltaAxial >= LIMITE_BANANA_CRIT) {
                addAi("üö® PELIGRO BANANA CR√çTICO: ŒîT Axial > "+deltaAxial.toFixed(0)+"¬∞. ¬°GIRO CONTINUO!", "text-red-500 font-black animate-pulse");
                intensiveTrigger = true;
            } else if (deltaAxial >= LIMITE_BANANA_WARN) {
                addAi("‚ö†Ô∏è ADVERTENCIA BANANA: Diferencial axial elevado ("+deltaAxial.toFixed(0)+"¬∞).", "text-orange-500");
                if (deltaAxial > 60) intensiveTrigger = true;
            }

            // 2. Draft (Inverso)
            if (draft !== null) {
                if (draft > f.draft[0]) {
                    addAi("üí® TIRO BAJO: Riesgo de retroceso de llama. -> ABRIR D√ÅMPER.", "text-red-500 font-bold");
                    intensiveTrigger = true;
                } else if (draft < f.draft[1]) {
                    addAi("üå¨Ô∏è EXCESO DE SUCCI√ìN: P√©rdida de calor. -> CERRAR D√ÅMPER.", "text-orange-400");
                }
            }

            // 3. Alertas T√©rmicas
            if (ti > 0) {
                if (ti < f.temp[0]) addAi("üî• BAJA TEMP: Incrementar flujo de combustible.", "text-orange-400");
                else if (ti > f.temp[1]) {
                    addAi("üõë ALTA TEMP: Reducir combustible para proteger refractario.", "text-red-500 font-bold");
                    intensiveTrigger = true;
                }

                // Salto T√©rmico (Protecci√≥n)
                const jump = Math.abs(ti - state.lastTi);
                if (jump > LIMITE_SALTO && state.lastTi > 0) {
                    addAi("üìà SALTO T√âRMICO DETECTADO: Var: "+jump.toFixed(0)+"¬∞C. ¬°Estabilizar!", "text-red-600 font-black");
                    intensiveTrigger = true;
                }
            }

            // Gesti√≥n de Frecuencia Inteligente
            if (intensiveTrigger) {
                state.freqMode = 'INTENSIVE';
                state.stableCount = 0;
            }

            if (console.innerHTML === "") addAi("‚úÖ Estabilidad operativa detectada.", "text-emerald-500 opacity-60");
        }

        function addAi(txt, cls) {
            const p = document.createElement('p');
            p.className = cls;
            p.innerText = txt;
            document.getElementById('ia-console').appendChild(p);
        }

        // --- PERSISTENCIA & LOGS ---
        function confirmRotation() {
            state.giroDeg = (state.giroDeg + 90) % 360;
            document.getElementById('compass-dial').style.transform = `rotate(${state.giroDeg}deg)`;
            document.getElementById('giro-text').innerText = `${state.giroDeg}¬∞`;
            state.rotSeconds = FASES[state.phase].rot * 60;
            document.getElementById('rotation-card').classList.remove('alert-active');
        }

        function saveRecord() {
            const op = document.getElementById('op_name').value;
            const punta = document.getElementById('op_punta').value;
            const ti = parseInt(document.getElementById('main-ti').innerText);
            const draft = document.getElementById('in-draft').value;

            // Validaciones
            if (!op || ti === 0) {
                alert("Validaci√≥n Fallida: Operador vac√≠o o Temperatura en cero.");
                return;
            }

            // Evitar duplicados en el mismo minuto
            const nowTime = Math.floor(state.seconds / 60);
            if (nowTime === state.lastSaveTime) {
                alert("Registro bloqueado: Espere 1 minuto para evitar duplicados.");
                return;
            }

            const record = {
                h: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                t_proc: document.getElementById('master-clock').innerText,
                op: `${op} [${punta}]`,
                ti: ti,
                mode: state.mode,
                draft: draft || "0",
                freq: state.freqMode === 'INTENSIVE' ? 'INT' : 'NOR',
                giro: state.giroDeg + "¬∞"
            };

            state.logs.unshift(record);
            state.lastSaveTime = nowTime;
            state.lastTi = ti;

            // Manejo de regreso a frecuencia normal
            if (state.freqMode === 'INTENSIVE') {
                state.stableCount++;
                if (state.stableCount >= 3) {
                    state.freqMode = 'NORMAL';
                    state.stableCount = 0;
                }
            }

            saveToLocal();
            renderLogs();
            
            // Limpiar inputs
            if(document.getElementById('in-tc')) document.getElementById('in-tc').value = "";
            if(document.getElementById('l1')) {
                document.getElementById('l1').value = "";
                document.getElementById('l2').value = "";
                document.getElementById('l3').value = "";
            }
            document.getElementById('in-draft').value = "";
            process();
        }

        function renderLogs() {
            const list = document.getElementById('log-list');
            list.innerHTML = state.logs.map(l => `
                <div class="bg-white/5 p-3 rounded-2xl border border-white/5 relative overflow-hidden group">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-zinc-500 font-black">${l.h} | T:${l.t_proc}</span>
                        <span class="text-fuego font-black text-xs">${l.ti}¬∞C</span>
                    </div>
                    <div class="flex justify-between text-[7px] font-bold uppercase tracking-widest text-zinc-400">
                        <span>${l.op}</span>
                        <span class="${l.freq === 'INT' ? 'text-orange-500' : 'text-emerald-500'}">F:${l.freq}</span>
                    </div>
                    <div class="mt-1 flex gap-2 text-[7px] font-bold text-zinc-600">
                        <span>DRAFT: ${l.draft}</span>
                        <span>MODO: ${l.mode}</span>
                        <span>GIRO: ${l.giro}</span>
                    </div>
                </div>
            `).join('');
        }

        function saveToLocal() {
            localStorage.setItem('otm_55_sec', state.seconds);
            localStorage.setItem('otm_55_logs', JSON.stringify(state.logs));
            localStorage.setItem('otm_55_op', document.getElementById('op_name').value);
            localStorage.setItem('otm_55_punta', document.getElementById('op_punta').value);
            
            // Sync dot indicator
            const dot = document.getElementById('sync-dot');
            dot.className = "status-dot bg-emerald-500";
            document.getElementById('sync-text').innerText = "Sincronizado";
        }

        function exportCSV() {
            let csv = "Hora,Total_Proc,Operador,Ti,Modo,Draft,Freq,Giro\n";
            state.logs.forEach(l => {
                csv += `${l.h},${l.t_proc},${l.op},${l.ti},${l.mode},${l.draft},${l.freq},${l.giro}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `OTM120H_V55_Report_${Date.now()}.csv`;
            a.click();
        }

        function hours() { return state.seconds / 3600; }
    </script>

    <style>
        @keyframes pulse-alert {
            0%, 100% { border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05); }
            50% { border-color: #ef4444; background: rgba(239, 68, 68, 0.2); }
        }
        .alert-active { animation: pulse-alert 1.5s infinite; }
        .animate-spin-slow { animation: spin 12s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</body>
</html>           
