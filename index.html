<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTM 120H (V7) - Master Control</title>
    <style>
        :root {
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
            --accent: #00e676;
            --warning: #ff9100;
            --danger: #ff5252;
            --text: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Bloqueo de Seguridad */
        #lock-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Header */
        header {
            background: #000;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent);
        }

        /* Dashboard Principal */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 15px;
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .panel {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        /* Br√∫jula de Fase */
        .phase-compass {
            border-left: 5px solid var(--accent);
        }

        .phase-target {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
        }

        /* Temperatura Central */
        .temp-display {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .ti-large {
            font-size: 8rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
            margin: 0;
        }

        /* Gr√°fico de Horno */
        #kiln-svg {
            width: 200px;
            height: 200px;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .alarm-blink {
            animation: blink 0.5s infinite alternate;
        }

        @keyframes blink {
            from { filter: drop-shadow(0 0 5px red); }
            to { filter: drop-shadow(0 0 20px red); background: rgba(255,0,0,0.2); }
        }

        /* Bit√°cora */
        .log-container {
            grid-column: 1 / span 3;
            max-height: 200px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 0.85rem;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: #000; position: sticky; top: 0; }
        td, th { padding: 8px; border: 1px solid #333; text-align: left; }

        input, select, button {
            background: #333;
            border: 1px solid var(--accent);
            color: white;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }

        button:active { transform: scale(0.98); }
        .btn-giro { background: #2979ff; border-color: #2979ff; height: 60px; font-size: 1.2em; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h2>SISTEMA OTM 120H V7</h2>
    <p>Ingrese PIN Maestro para Desbloquear</p>
    <input type="password" id="pin-input" placeholder="****" style="width: 100px; text-align: center; font-size: 1.5em;">
    <button onclick="unlock()" style="width: 120px;">ENTRAR</button>
</div>

<header>
    <div>
        <strong>S.E.R.A. Industrial</strong> | OTM 120H
    </div>
    <div>
        OP: <input type="text" id="operator-name" placeholder="Nombre Operador" style="width: 150px; margin:0; display:inline;">
        PUNTA: <select id="shift-select" style="width: 80px; margin:0; display:inline;">
            <option>A</option><option>B</option><option>C</option>
        </select>
    </div>
</header>

<div class="main-grid">
    <div class="panel phase-compass">
        <h3>BR√öJULA DE FASE</h3>
        <div id="phase-id" class="phase-target">FASE 1: CALENTAMIENTO INICIAL</div>
        <hr>
        <p>üéØ T¬∞ Objetivo: <span id="target-temp">120-150</span> ¬∞C</p>
        <p>üå™Ô∏è Tiro (Draft): <span id="target-draft">-1.0 a -2.5</span> mmca</p>
        <p>üîÑ Frec. Giro: <span id="target-rot">60</span> min</p>
        <hr>
        <div id="ia-monitor" style="color: var(--warning); font-size: 0.9em; font-weight: bold;"></div>
    </div>

    <div class="panel temp-display" id="main-kiln-view">
        <div id="kiln-container">
            <svg id="kiln-svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" stroke="#666" stroke-width="2" fill="#333" />
                <circle cx="50" cy="50" r="38" stroke="#8d6e63" stroke-width="4" fill="none" />
                <circle cx="50" cy="50" r="10" fill="#ffab00" />
                <rect x="48" y="5" width="4" height="10" fill="var(--accent)" />
            </svg>
        </div>
        <p style="margin-top: 10px;">TEMPERATURA INTERNA ($T_i$)</p>
        <h1 class="ti-large" id="ti-val">--- ¬∞C</h1>
        <div style="display: flex; justify-content: space-around;">
            <div>
                <small>CRON√ìMETRO GLOBAL</small>
                <div id="global-timer" style="font-size: 1.5em; font-weight: bold;">000:00:00</div>
            </div>
            <div>
                <small>PR√ìXIMO GIRO</small>
                <div id="rotation-timer" style="font-size: 1.5em; font-weight: bold; color: var(--warning);">00:00</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>ENTRADA DE DATOS</h3>
        <label>Modo de Medici√≥n:</label>
        <select id="measure-mode" onchange="toggleInputs()">
            <option value="TC">Termocupla (Carcasa Fr√≠a)</option>
            <option value="Laser">Pistola L√°ser (Casco Caliente)</option>
        </select>

        <div id="tc-input-div">
            <label>$T_{externa}$ Directa:</label>
            <input type="number" id="t-direct" placeholder="¬∞C">
        </div>

        <div id="laser-input-div" style="display: none;">
            <label>$L_1$ (Carga):</label> <input type="number" id="l1-val" placeholder="¬∞C">
            <label>$L_2$ (Centro):</label> <input type="number" id="l2-val" placeholder="¬∞C">
            <label>$L_3$ (Descarga):</label> <input type="number" id="l3-val" placeholder="¬∞C">
        </div>

        <label>Draft (mmca):</label>
        <input type="number" id="draft-val" step="0.1" placeholder="-1.5">

        <button onclick="recordData()">REGISTRAR PAR√ÅMETROS</button>
        <button class="btn-giro" onclick="executeRotation()">üîÑ REALIZAR GIRO (+90¬∞)</button>
        <button onclick="exportCSV()" style="background: #555; border: none; font-size: 0.7em;">Descargar CSV</button>
        <button onclick="resetGlobal()" style="color:red; background:none; border:none; font-size: 0.7em; margin-top:20px;">Reiniciar Global (PIN)</button>
    </div>

    <div class="panel log-container">
        <table>
            <thead>
                <tr>
                    <th>HORA</th>
                    <th>OP</th>
                    <th>$T_i$ (¬∞C)</th>
                    <th>ORIGEN</th>
                    <th>DRAFT</th>
                    <th>EVENTO / OBSERVACI√ìN</th>
                </tr>
            </thead>
            <tbody id="log-body"></tbody>
        </table>
    </div>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    // --- Configuraci√≥n y Estado ---
    let state = {
        globalSeconds: 0,
        rotationSeconds: 3600, // Fase 1 default
        angle: 0,
        logs: [],
        pin: "1407",
        isLocked: true
    };

    const PHASES = [
        { limit: 24, tRange: [120, 150], rot: 60, draft: [-1.0, -2.5], name: "FASE 1: CALENTAMIENTO" },
        { limit: 72, tRange: [320, 350], rot: 30, draft: [-1.2, -2.5], name: "FASE 2: DESHIDRATACI√ìN" },
        { limit: 120, tRange: [600, 650], rot: 15, draft: [-1.5, -2.5], name: "FASE 3: SINTERIZACI√ìN" }
    ];

    // --- Persistencia ---
    function save() { localStorage.setItem('otm_v7_state', JSON.stringify(state)); }
    function load() {
        const saved = localStorage.getItem('otm_v7_state');
        if (saved) {
            state = JSON.parse(saved);
            renderLogs();
            rotateVisual(0);
        }
    }

    // --- Seguridad ---
    function unlock() {
        if (document.getElementById('pin-input').value === state.pin) {
            document.getElementById('lock-screen').style.display = 'none';
            state.isLocked = false;
            startTimers();
        } else { alert("PIN Incorrecto"); }
    }

    function resetGlobal() {
        if (confirm("¬øReiniciar Cron√≥metro Global? Requiere PIN.") && prompt("PIN:") === state.pin) {
            state.globalSeconds = 0;
            save();
            location.reload();
        }
    }

    // --- L√≥gica T√©rmica y de Fase ---
    function getCurrentPhase() {
        const hours = state.globalSeconds / 3600;
        return PHASES.find(p => hours < p.limit) || PHASES[2];
    }

    function toggleInputs() {
        const mode = document.getElementById('measure-mode').value;
        document.getElementById('tc-input-div').style.display = mode === 'TC' ? 'block' : 'none';
        document.getElementById('laser-input-div').style.display = mode === 'Laser' ? 'block' : 'none';
    }

    // --- Timers ---
    function startTimers() {
        setInterval(() => {
            state.globalSeconds++;
            if (state.rotationSeconds > 0) {
                state.rotationSeconds--;
            } else {
                triggerAlarm();
            }
            updateUI();
            save();
        }, 1000);
    }

    function updateUI() {
        const phase = getCurrentPhase();
        
        // Cron√≥metros
        document.getElementById('global-timer').innerText = formatTime(state.globalSeconds, true);
        document.getElementById('rotation-timer').innerText = formatTime(state.rotationSeconds, false);
        
        // Br√∫jula
        document.getElementById('phase-id').innerText = phase.name;
        document.getElementById('target-temp').innerText = `${phase.tRange[0]}-${phase.tRange[1]}`;
        document.getElementById('target-draft').innerText = `${phase.draft[0]} a ${phase.draft[1]}`;
        document.getElementById('target-rot').innerText = phase.rot;

        if (state.rotationSeconds === 0) {
            document.getElementById('main-kiln-view').classList.add('alarm-blink');
        } else {
            document.getElementById('main-kiln-view').classList.remove('alarm-blink');
        }
    }

    function formatTime(sec, long) {
        let h = Math.floor(sec / 3600);
        let m = Math.floor((sec % 3600) / 60);
        let s = sec % 60;
        if (long) return `${h.toString().padStart(3, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // --- Registro y Giro ---
    function executeRotation() {
        const op = document.getElementById('operator-name').value || "S/N";
        state.angle += 90;
        rotateVisual(90);
        
        const phase = getCurrentPhase();
        state.rotationSeconds = phase.rot * 60;

        const log = {
            time: new Date().toLocaleTimeString(),
            op: op,
            ti: "-",
            origin: "GIRO",
            draft: "-",
            event: `GIRO REALIZADO - √Ångulo: ${state.angle % 360}¬∞`
        };
        state.logs.unshift(log);
        renderLogs();
    }

    function rotateVisual(deg) {
        document.getElementById('kiln-svg').style.transform = `rotate(${state.angle}deg)`;
    }

    function recordData() {
        const mode = document.getElementById('measure-mode').value;
        const op = document.getElementById('operator-name').value || "S/N";
        const draft = parseFloat(document.getElementById('draft-val').value);
        let ti = 0;
        let ext = 0;

        if (mode === 'TC') {
            ext = parseFloat(document.getElementById('t-direct').value);
            ti = ext * 3.5;
        } else {
            const l1 = parseFloat(document.getElementById('l1-val').value);
            const l2 = parseFloat(document.getElementById('l2-val').value);
            const l3 = parseFloat(document.getElementById('l3-val').value);
            
            // Efecto Banana
            if (Math.abs(l1 - l3) > 80) alert("‚ö†Ô∏è ALERTA: EFECTO BANANA DETECTADO (Dif. L1/L3 > 80¬∞C)");
            
            ext = (l1 + l2 + l3) / 3;
            ti = ext * 3.5;
        }

        if (isNaN(ti) || ext > 500 || draft > 0) {
            alert("ERROR: Valores fuera de rango o inv√°lidos.");
            return;
        }

        document.getElementById('ti-val').innerText = `${Math.round(ti)} ¬∞C`;

        const log = {
            time: new Date().toLocaleTimeString(),
            op: op,
            ti: Math.round(ti),
            origin: mode,
            draft: draft,
            event: "LECTURA RUTINA"
        };

        state.logs.unshift(log);
        renderLogs();
        checkAlerts(ti, draft);
    }

    function checkAlerts(ti, draft) {
        const phase = getCurrentPhase();
        let msg = "";
        
        if (draft > phase.draft[0]) msg += "‚ö†Ô∏è TIRO BAJO (Abrir D√°mper) | ";
        if (draft < phase.draft[1]) msg += "‚ö†Ô∏è TIRO EXCESIVO (Cerrar D√°mper) | ";
        if (ti < phase.tRange[0]) msg += "‚ö†Ô∏è T¬∞ BAJA (Subir Quemador)";
        if (ti > phase.tRange[1]) msg += "‚ö†Ô∏è T¬∞ ALTA (Bajar Quemador)";
        
        document.getElementById('ia-monitor').innerText = msg;
    }

    function renderLogs() {
        const body = document.getElementById('log-body');
        body.innerHTML = state.logs.map(l => `
            <tr>
                <td>${l.time}</td>
                <td>${l.op}</td>
                <td>${l.ti}</td>
                <td>${l.origin}</td>
                <td>${l.draft}</td>
                <td>${l.event}</td>
            </tr>
        `).join('');
    }

    function triggerAlarm() {
        document.getElementById('beep').play();
    }

    function exportCSV() {
        let csv = "Hora,Operador,Ti,Origen,Draft,Evento\n";
        state.logs.forEach(l => {
            csv += `${l.time},${l.op},${l.ti},${l.origin},${l.draft},${l.event}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `BITACORA_OTM120H_${new Date().toLocaleDateString()}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    window.onload = load;
</script>

</body>
</html>
