<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTM 120H - Sistema de Control Maestro</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #ff6600; --text: #e0e0e0;
            --blue: #00aaff; --green: #00ff88; --red: #ff4444;
        }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center;
        }
        .container { width: 100%; max-width: 500px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        h1 { color: var(--accent); font-size: 1.2rem; text-align: center; margin: 5px 0; }
        
        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input[type="password"], input[type="text"], input[type="number"] { 
            background: #333; border: 1px solid var(--accent); color: white; padding: 10px; border-radius: 5px; width: 80%; text-align: center; font-size: 1.1rem;
        }

        /* Dashboard */
        .ti-display { font-size: 4rem; font-weight: bold; color: var(--accent); text-align: center; display: block; margin: 10px 0; }
        .ti-sub { font-size: 0.9rem; text-align: center; color: #888; margin-bottom: 10px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; background: #333; color: white; }
        .mode-btn.active { background: var(--accent); }

        .compass { width: 100px; height: 100px; border: 4px solid var(--accent); border-radius: 50%; margin: 10px auto; position: relative; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: transform 0.5s; }
        
        .log-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin-top: 10px; }
        .log-table th, .log-table td { border-bottom: 1px solid #333; padding: 8px; text-align: left; }
        
        button.action { width: 100%; padding: 12px; background: var(--accent); border: none; color: white; border-radius: 8px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color:var(--accent)">SEGURIDAD OTM</h2>
        <input type="password" id="pin" placeholder="PIN" inputmode="numeric">
        <button class="action" onclick="checkLogin()">DESBLOQUEAR</button>
    </div>

    <div class="container" id="main-app" style="display:none;">
        <h1>SISTEMA DE CONTROL MAESTRO V5+</h1>
        
        <div class="card grid">
            <div class="phase-box">
                <div id="fase-label" style="font-weight:bold; color:var(--blue);">Cargando...</div>
                <div id="fase-range" style="font-size:0.8rem;">---</div>
            </div>
            <div class="timer-box" style="text-align:right;">
                <div id="global-timer" style="font-size:1.2rem; font-family:monospace;">00:00:00</div>
                <div style="font-size:0.6rem; color:#888;">TIEMPO TOTAL</div>
            </div>
        </div>

        <div class="card">
            <div class="ti-sub">TEMPERATURA INTERNA (Ti)</div>
            <div class="ti-display" id="ti-val">---°C</div>
        </div>

        <div class="card">
            <div class="mode-selector">
                <button class="mode-btn active" id="btn-tc" onclick="setMode('TC')">TC</button>
                <button class="mode-btn" id="btn-laser" onclick="setMode('LASER')">Láser</button>
            </div>
            <div id="tc-input-group">
                <input type="number" id="temp-direct" placeholder="Temp. TC (°C)" style="width:92%">
            </div>
            <div id="laser-input-group" style="display:none;">
                <div class="grid">
                    <input type="number" id="l1" placeholder="L1 Carga">
                    <input type="number" id="l2" placeholder="L2 Centro">
                    <input type="number" id="l3" placeholder="L3 Descarga">
                </div>
            </div>
            <input type="number" id="draft-val" placeholder="Draft (mmca)" style="width:92%; margin-top:10px;">
            <input type="text" id="operator" placeholder="Operador" style="width:92%; margin-top:10px;">
            <button class="action" onclick="saveLog()">REGISTRAR</button>
        </div>

        <div class="card" style="overflow-x:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.8rem; font-weight:bold;">BITÁCORA</span>
                <button onclick="exportCSV()" style="font-size:0.6rem; background:#444; color:white; border:none; padding:5px;">CSV</button>
            </div>
            <table class="log-table">
                <thead><tr><th>Hora</th><th>Ti</th><th>Modo</th><th>Op.</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>

    <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script>
        let mode = 'TC';
        let startTime = localStorage.getItem('otm_start') ? parseInt(localStorage.getItem('otm_start')) : Date.now();
        let logs = JSON.parse(localStorage.getItem('otm_logs')) || [];
        if(!localStorage.getItem('otm_start')) localStorage.setItem('otm_start', startTime);

        function checkLogin() {
            const inputPin = document.getElementById('pin').value.trim();
            if(inputPin === '1407') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initApp();
            } else {
                alert('PIN Incorrecto');
                document.getElementById('pin').value = ""; // Limpia el input sin registrar nada
            }
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btn-tc').classList.toggle('active', m === 'TC');
            document.getElementById('btn-laser').classList.toggle('active', m === 'LASER');
            document.getElementById('tc-input-group').style.display = m === 'TC' ? 'block' : 'none';
            document.getElementById('laser-input-group').style.display = m === 'LASER' ? 'block' : 'none';
        }

        function initApp() {
            setInterval(updateTimers, 1000);
            renderLogs();
        }

        function updateTimers() {
            const diff = Date.now() - startTime;
            const hours = Math.floor(diff / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            document.getElementById('global-timer').innerText = 
                `${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;

            let phase = 1, target = "120-150°C";
            if(hours >= 24 && hours < 72) { phase = 2; target = "320-350°C"; }
            else if(hours >= 72) { phase = 3; target = "600-650°C"; }
            
            document.getElementById('fase-label').innerText = `Fase ${phase}`;
            document.getElementById('fase-range').innerText = target;
        }

        function saveLog() {
            const op = document.getElementById('operator').value;
            if(!op) return alert('Operador requerido');

            let ti = 0;
            if(mode === 'TC') {
                ti = parseFloat(document.getElementById('temp-direct').value);
            } else {
                const avg = (parseFloat(document.getElementById('l1').value) + parseFloat(document.getElementById('l2').value) + parseFloat(document.getElementById('l3').value)) / 3;
                ti = avg * 3.5;
            }

            if(isNaN(ti) || ti <= 0) return alert('Temperatura inválida');

            logs.unshift({ time: new Date().toLocaleTimeString(), ti: ti.toFixed(1), mode: mode, op: op });
            localStorage.setItem('otm_logs', JSON.stringify(logs));
            document.getElementById('ti-val').innerText = `${ti.toFixed(1)}°C`;
            renderLogs();
        }

        function renderLogs() {
            const body = document.getElementById('log-body');
            body.innerHTML = logs.slice(0, 10).map(l => `<tr><td>${l.time}</td><td>${l.ti}°</td><td>${l.mode}</td><td>${l.op}</td></tr>`).join('');
        }

        function exportCSV() {
            let csv = "Hora,Ti,Modo,Operador\n";
            logs.forEach(l => { csv += `${l.time},${l.ti},${l.mode},${l.op}\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = 'log_horno.csv';
            a.click();
        }
    </script>
</body>
</html>
