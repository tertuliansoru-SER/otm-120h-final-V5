<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTM 120H - MASTER V5.5</title>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --accent: #ff6600; --blue: #00aaff; --text: #e0e0e0; --red: #ff3333; --green: #00ff88; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #222; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        h1 { color: var(--accent); font-size: 1.1rem; text-align: center; letter-spacing: 2px; margin: 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        /* LOGIN SEGURO */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .pin-box { background: var(--card); border: 2px solid var(--accent); padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; }
        
        /* TI DISPLAY GIGANTE */
        .ti-label { text-align: center; font-size: 0.8rem; color: #888; letter-spacing: 1px; }
        .ti-display { font-size: 5.5rem; font-weight: 900; color: var(--accent); text-align: center; line-height: 1; margin: 10px 0; text-shadow: 0 0 25px rgba(255,102,0,0.4); }
        
        /* GIRO Y DRAFT */
        .compass { width: 90px; height: 90px; border: 3px solid var(--accent); border-radius: 50%; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: var(--accent); }
        .btn-giro { width: 100%; padding: 10px; background: #252525; color: white; border: 1px solid #444; border-radius: 6px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }

        /* INPUTS INDUSTRIALES */
        input { background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1.1rem; margin-top: 8px; }
        input:focus { border-color: var(--accent); outline: none; background: #222; }
        .mode-selector { display: flex; gap: 8px; margin-bottom: 12px; }
        .mode-btn { flex: 1; padding: 12px; border: 1px solid #333; background: #1a1a1a; color: #666; border-radius: 8px; font-weight: bold; }
        .mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 10px rgba(255,102,0,0.3); }
        
        button.save { width: 100%; padding: 18px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 900; font-size: 1.2rem; margin-top: 15px; cursor: pointer; }
        
        /* ALERTAS */
        .alert-area { min-height: 20px; color: var(--red); font-weight: bold; text-align: center; font-size: 0.85rem; margin-top: 5px; }
        .draft-status { font-size: 0.7rem; font-weight: bold; margin-top: 5px; }

        /* BITÁCORA */
        .log-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin-top: 10px; }
        .log-table th { color: var(--blue); text-align: left; padding: 8px 5px; border-bottom: 2px solid #333; }
        .log-table td { padding: 10px 5px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="pin-box">
            <h2 style="color:var(--accent); margin-bottom:20px;">SEGURIDAD OTM</h2>
            <input type="password" id="pin" placeholder="PIN" inputmode="numeric" style="width:100%; font-size:2rem; letter-spacing:8px;">
            <button class="save" onclick="checkLogin()">DESBLOQUEAR</button>
        </div>
    </div>

    <div class="container" id="main-app" style="display:none;">
        <h1>CONTROL MAESTRO OTM 120H</h1>
        
        <div class="card grid" style="display: grid; grid-template-columns: 1.2fr 0.8fr;">
            <div style="border-left: 4px solid var(--blue); padding-left: 10px;">
                <div id="phase-text" style="font-weight:bold; color:var(--blue); font-size:1.2rem;">FASE 1</div>
                <div id="phase-goal" style="font-size:0.75rem; color:#888;">Objetivo: 120-150°C</div>
            </div>
            <div style="text-align:right;">
                <div id="timer-display" style="font-family:monospace; font-size:1.3rem; color:var(--green);">00:00:00</div>
                <div style="font-size:0.6rem; color:#555;">TIEMPO DE CURADO</div>
            </div>
        </div>

        <div class="card">
            <div class="ti-label">TEMPERATURA INTERNA (Ti)</div>
            <div class="ti-display" id="ti-val">---°C</div>
            <div id="alert-msg" class="alert-area"></div>
        </div>

        <div class="card" style="display: grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div style="text-align:center; border-right: 1px solid #333;">
                <div id="compass-ui" class="compass">0°</div>
                <button class="btn-giro" onclick="rotate90()">Giro +90°</button>
                <div id="turn-countdown" style="font-size:0.65rem; color:var(--green); margin-top:8px; font-weight:bold;">Prox: 60m</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:0.7rem; color:#888; text-transform:uppercase;">Tiro (Draft)</div>
                <div id="draft-icon" style="font-size:2rem; margin:5px 0;">--</div>
                <div id="draft-advice" class="draft-status" style="color:var(--blue);">SIN DATOS</div>
            </div>
        </div>

        <div class="card">
            <div class="mode-selector">
                <button class="mode-btn active" id="btn-tc" onclick="setMode('TC')">TERMOCUPLA</button>
                <button class="mode-btn" id="btn-laser" onclick="setMode('LASER')">P. LÁSER</button>
            </div>
            
            <div id="input-tc">
                <input type="number" id="val-tc" placeholder="Lectura TC (°C)">
            </div>
            <div id="input-laser" style="display:none;">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                    <input type="number" id="l1" placeholder="Carga">
                    <input type="number" id="l2" placeholder="Centro">
                    <input type="number" id="l3" placeholder="Desc.">
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="val-draft" placeholder="Draft mmca" step="0.1">
                <input type="text" id="val-op" placeholder="Operador">
            </div>
            <button class="save" onclick="processData()">REGISTRAR DATOS</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-size:0.8rem; font-weight:bold; color:var(--blue);">HISTORIAL DE OPERACIÓN</span>
                <button onclick="downloadLogs()" style="background:#333; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:0.6rem;">EXPORTAR CSV</button>
            </div>
            <table class="log-table">
                <thead><tr><th>HORA</th><th>Ti</th><th>DRAFT</th><th>OP.</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>

    <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script>
        let currentMode = 'TC';
        let currentAngle = 0;
        let wakeLock = null;
        let startTime = localStorage.getItem('otm_start_v55') ? parseInt(localStorage.getItem('otm_start_v55')) : Date.now();
        let logs = JSON.parse(localStorage.getItem('otm_logs_v55')) || [];
        if(!localStorage.getItem('otm_start_v55')) localStorage.setItem('otm_start_v55', startTime);

        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        // CONTROL DE ACCESO SEGURO (CORREGIDO)
        function checkLogin() {
            const pinVal = document.getElementById('pin').value.trim();
            if(pinVal === '1407') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                requestWakeLock();
                startSystem();
            } else {
                alert('PIN INCORRECTO');
                document.getElementById('pin').value = '';
                // NO se registra nada en bitácora aquí por seguridad
            }
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('btn-tc').classList.toggle('active', m === 'TC');
            document.getElementById('btn-laser').classList.toggle('active', m === 'LASER');
            document.getElementById('input-tc').style.display = m === 'TC' ? 'block' : 'none';
            document.getElementById('input-laser').style.display = m === 'LASER' ? 'block' : 'none';
        }

        function startSystem() {
            setInterval(updateClock, 1000);
            renderLogs();
        }

        function updateClock() {
            const now = Date.now();
            const diff = now - startTime;
            const h = Math.floor(diff/3600000);
            const m = Math.floor((diff%3600000)/60000);
            const s = Math.floor((diff%60000)/1000);
            
            document.getElementById('timer-display').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

            let p = 1, g = "120-150°C", t = 60;
            if(h >= 24 && h < 72) { p = 2; g = "320-350°C"; t = 30; }
            else if(h >= 72) { p = 3; g = "600-650°C"; t = 15; }

            document.getElementById('phase-text').innerText = `FASE ${p}`;
            document.getElementById('phase-goal').innerText = `Objetivo: ${g}`;
            
            let remainingMins = t - (m % t);
            document.getElementById('turn-countdown').innerText = `PROX: ${remainingMins}m`;
            if(remainingMins === t && s === 0) document.getElementById('beep').play();
        }

        function rotate90() {
            currentAngle = (currentAngle + 90) % 360;
            document.getElementById('compass-ui').style.transform = `rotate(${currentAngle}deg)`;
            document.getElementById('compass-ui').innerText = `${currentAngle}°`;
        }

        function processData() {
            const op = document.getElementById('val-op').value.trim();
            const draft = parseFloat(document.getElementById('val-draft').value);
            if(!op || isNaN(draft)) return alert('DATOS DE OPERADOR O DRAFT INCOMPLETOS');

            let ti = 0;
            if(currentMode === 'TC') {
                ti = parseFloat(document.getElementById('val-tc').value);
            } else {
                const c1 = parseFloat(document.getElementById('l1').value);
                const c2 = parseFloat(document.getElementById('l2').value);
                const c3 = parseFloat(document.getElementById('l3').value);
                if(Math.abs(c1 - c3) > 80) document.getElementById('alert-msg').innerText = "⚠️ ALERTA: EFECTO BANANA (>80°C Δ)";
                else document.getElementById('alert-msg').innerText = "";
                ti = ((c1 + c2 + c3) / 3) * 3.5;
            }

            if(isNaN(ti) || ti <= 0) return alert('VALOR DE TEMPERATURA NO VÁLIDO');

            // Actualizar Interfaz
            document.getElementById('ti-val').innerText = `${ti.toFixed(1)}°C`;
            document.getElementById('draft-icon').innerText = draft > -1.0 ? "⚠️" : "✓";
            document.getElementById('draft-advice').innerText = draft > -1.0 ? "ABRIR DÁMPER" : "TIRO ÓPTIMO";
            document.getElementById('draft-advice').style.color = draft > -1.0 ? "var(--red)" : "var(--blue)";

            // Guardar en Bitácora
            logs.unshift({ h: new Date().toLocaleTimeString(), ti: ti.toFixed(1), dr: draft, op: op });
            localStorage.setItem('otm_logs_v55', JSON.stringify(logs));
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('log-body');
            container.innerHTML = logs.slice(0,10).map(l => `
                <tr><td>${l.h}</td><td>${l.ti}°</td><td>${l.dr}</td><td>${l.op}</td></tr>
            `).join('');
        }

        function downloadLogs() {
            let csv = "HORA,Ti,DRAFT,OPERADOR\n";
            logs.forEach(l => csv += `${l.h},${l.ti},${l.dr},${l.op}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'REPORTE_OTM_120H.csv'; a.click();
        }
    </script>
</body>
</html>
