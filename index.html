<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTM 120H - MASTER V5.5</title>
    <style>
        :root {
            --bg: #050505; --card: #121212; --accent: #ff5500; --blue: #0088ff; 
            --text: #f0f0f0; --red: #ff2222; --green: #00e676; --border: #2a2a2a;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; padding-bottom: 20px; }
        .card { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.8); }
        h1 { color: var(--accent); font-size: 1.2rem; text-align: center; letter-spacing: 2px; text-transform: uppercase; margin: 5px 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* LOGIN SEGURO */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .pin-box { background: var(--card); border: 2px solid var(--accent); padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px; }
        .pin-box input { font-size: 2.5rem; text-align: center; letter-spacing: 10px; padding: 10px; border-radius: 8px; border: 1px solid var(--accent); background: #000; color: white; width: 80%; margin-bottom: 20px; }

        /* JERARQUÍA VISUAL: TI GIGANTE */
        .ti-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; }
        .ti-label { font-size: 0.9rem; color: #888; letter-spacing: 2px; text-transform: uppercase; }
        .ti-display { font-size: 6rem; font-weight: 900; color: var(--accent); line-height: 1; margin: 10px 0; text-shadow: 0 0 30px rgba(255,85,0,0.5); }
        .alert-zone { min-height: 25px; font-weight: bold; font-size: 0.9rem; text-align: center; width: 100%; }
        .alert-red { color: var(--red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* GRID SYSTEM */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        /* BRÚJULA Y FASE */
        .compass-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .compass { width: 80px; height: 80px; border: 4px solid var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.4rem; transition: transform 0.5s ease-out; margin-bottom: 10px; color: var(--accent); background: radial-gradient(circle, #222 0%, #000 100%); }
        .turn-timer { font-size: 1.5rem; font-family: monospace; color: var(--green); font-weight: bold; margin: 5px 0; }

        /* INPUTS INDUSTRIALES */
        input { background: #111; border: 1px solid #444; color: white; padding: 14px; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1.1rem; }
        input:focus { border-color: var(--blue); outline: none; background: #1a1a1a; }
        input::placeholder { color: #555; }
        
        .mode-btn { padding: 12px; border: 1px solid #333; background: #111; color: #777; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer; width: 100%; }
        .mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        button.action-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 900; font-size: 1.1rem; text-transform: uppercase; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 10px rgba(255,85,0,0.3); }
        button.action-btn:active { transform: scale(0.98); }
        button.secondary-btn { background: #333; border: 1px solid #555; padding: 10px; border-radius: 6px; color: white; font-weight: bold; width: 100%; cursor: pointer; }

        /* BITÁCORA */
        .log-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin-top: 10px; }
        .log-table th { color: var(--blue); text-align: left; padding: 8px 4px; border-bottom: 2px solid var(--border); text-transform: uppercase; }
        .log-table td { padding: 10px 4px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="pin-box">
            <h2 style="color:var(--accent); margin-top:0;">CONTROL DE ACCESO</h2>
            <p style="color:#888; font-size:0.8rem;">SISTEMA OTM 120H</p>
            <input type="password" id="pin-input" inputmode="numeric" maxlength="4" placeholder="****">
            <button class="action-btn" onclick="verifyPin()">DESBLOQUEAR</button>
        </div>
    </div>

    <div class="container" id="main-app" style="display:none;">
        <h1>MONITOR MAESTRO V5.5</h1>
        
        <div class="card grid-2" style="border-left: 5px solid var(--blue);">
            <div>
                <div id="phase-title" style="font-weight:900; color:var(--blue); font-size:1.4rem;">FASE 1</div>
                <div id="phase-temp" style="font-size:0.8rem; color:#aaa;">Rango: 120-150°C</div>
                <div id="phase-draft" style="font-size:0.8rem; color:#aaa;">Draft: -1.0 a -2.5</div>
            </div>
            <div style="text-align:right; display:flex; flex-direction:column; justify-content:center;">
                <div style="font-size:0.7rem; color:#888;">TIEMPO DE CURADO</div>
                <div id="global-timer" style="font-family:monospace; font-size:1.6rem; font-weight:bold;">00:00:00</div>
            </div>
        </div>

        <div class="card ti-container">
            <div class="ti-label">Temperatura Interna (Ti)</div>
            <div class="ti-display" id="ti-display">---°C</div>
            <div id="main-alert" class="alert-zone"></div>
        </div>

        <div class="card grid-2">
            <div class="compass-container" style="border-right: 1px solid var(--border);">
                <div id="compass" class="compass">0°</div>
                <div style="font-size:0.7rem; color:#888;">PRÓXIMO GIRO EN:</div>
                <div id="turn-timer" class="turn-timer">00:00</div>
                <button class="secondary-btn" style="margin-top:5px; font-size:0.75rem;" onclick="markTurn()">MARCAR GIRO +90°</button>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding-left:10px;">
                <div style="font-size:0.7rem; color:#888; text-transform:uppercase;">Diagnóstico Draft</div>
                <div id="draft-status" style="font-size:1.1rem; font-weight:bold; margin:10px 0; color:var(--blue); text-align:center;">ESPERANDO LECTURA</div>
                <div id="draft-action" style="font-size:0.85rem; font-weight:bold; text-align:center;">---</div>
            </div>
        </div>

        <div class="card">
            <div class="grid-2" style="margin-bottom:15px;">
                <button class="mode-btn active" id="btn-tc" onclick="toggleMode('TC')">MODO TC</button>
                <button class="mode-btn" id="btn-laser" onclick="toggleMode('LASER')">MODO LÁSER</button>
            </div>
            
            <div id="area-tc" style="margin-bottom:15px;">
                <input type="number" id="in-tc" placeholder="Lectura Termocupla (°C)">
            </div>
            
            <div id="area-laser" class="grid-3" style="display:none; margin-bottom:15px;">
                <input type="number" id="in-l1" placeholder="L1 Carga">
                <input type="number" id="in-l2" placeholder="L2 Centro">
                <input type="number" id="in-l3" placeholder="L3 Desc.">
            </div>

            <div style="margin-bottom:15px;">
                <input type="number" id="in-draft" placeholder="Lectura Draft (ej. -1.5)" step="0.1">
            </div>

            <div class="grid-2">
                <input type="text" id="in-op" placeholder="Operador">
                <input type="text" id="in-punta" placeholder="Punta (Turno)">
            </div>
            
            <button class="action-btn" onclick="saveRecord()">REGISTRAR LECTURA</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; color:var(--blue); font-size:0.9rem;">BITÁCORA OPERATIVA</span>
                <button class="secondary-btn" style="width:auto; font-size:0.7rem;" onclick="exportCSV()">EXPORTAR CSV</button>
            </div>
            <table class="log-table">
                <thead><tr><th>Hora</th><th>Op/Punta</th><th>Modo</th><th>Ti</th><th>Draft</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>

    <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

    <script>
        // VARIABLES GLOBALES Y PERSISTENCIA
        let mode = 'TC';
        let currentAngle = parseInt(localStorage.getItem('otm_angle')) || 0;
        let wakeLock = null;
        
        let startTime = localStorage.getItem('otm_start_v55');
        if(!startTime) { startTime = Date.now(); localStorage.setItem('otm_start_v55', startTime); }
        else { startTime = parseInt(startTime); }

        let lastTurnTime = localStorage.getItem('otm_last_turn');
        if(!lastTurnTime) { lastTurnTime = Date.now(); localStorage.setItem('otm_last_turn', lastTurnTime); }
        else { lastTurnTime = parseInt(lastTurnTime); }

        let logs = JSON.parse(localStorage.getItem('otm_logs_v55')) || [];

        // CONSTANTES FÍSICAS
        const FACTOR_REFRACTARIO = 3.5;
        const LIMITE_TEMP = 850;
        const EFECTO_BANANA_MAX = 80;

        // ESTADOS DE FASE
        let currentPhaseInfo = {};

        // INICIALIZACIÓN DE UI
        document.getElementById('compass').style.transform = `rotate(${currentAngle}deg)`;
        document.getElementById('compass').innerText = `${currentAngle}°`;

        // 1. SEGURIDAD Y WAKELOCK
        async function enableWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        function verifyPin() {
            const pin = document.getElementById('pin-input').value.trim();
            if(pin === '1407') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                enableWakeLock();
                renderLogs();
                setInterval(engineTick, 1000);
                engineTick(); // Llamada inicial
            } else {
                alert('ACCESO DENEGADO: PIN INCORRECTO');
                document.getElementById('pin-input').value = '';
            }
        }

        // 2. INTERFAZ
        function toggleMode(selected) {
            mode = selected;
            document.getElementById('btn-tc').classList.toggle('active', mode === 'TC');
            document.getElementById('btn-laser').classList.toggle('active', mode === 'LASER');
            document.getElementById('area-tc').style.display = mode === 'TC' ? 'block' : 'none';
            document.getElementById('area-laser').style.display = mode === 'LASER' ? 'grid' : 'none';
        }

        // 3. MOTOR DE TIEMPO Y FASES
        function engineTick() {
            const now = Date.now();
            
            // Cronómetro Global
            const diffGlobal = now - startTime;
            const h = Math.floor(diffGlobal / 3600000);
            const m = Math.floor((diffGlobal % 3600000) / 60000);
            const s = Math.floor((diffGlobal % 60000) / 1000);
            document.getElementById('global-timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

            // Determinar Fase
            let phaseNum = 1, tempGoal = "120-150°C", turnIntervalMins = 60, draftMin = -1.0, draftMax = -2.5;
            if (h >= 24 && h < 72) { phaseNum = 2; tempGoal = "320-350°C"; turnIntervalMins = 30; draftMin = -1.2; }
            else if (h >= 72) { phaseNum = 3; tempGoal = "600-650°C"; turnIntervalMins = 15; draftMin = -1.5; }
            
            currentPhaseInfo = { min: draftMin, max: draftMax };

            document.getElementById('phase-title').innerText = `FASE ${phaseNum}`;
            document.getElementById('phase-temp').innerText = `Rango: ${tempGoal}`;
            document.getElementById('phase-draft').innerText = `Draft: ${draftMin} a ${draftMax}`;

            // Cronómetro de Giro
            const diffTurn = now - lastTurnTime;
            const turnMinsElapsed = Math.floor(diffTurn / 60000);
            const turnSecsElapsed = Math.floor((diffTurn % 60000) / 1000);
            
            let minsLeft = turnIntervalMins - turnMinsElapsed - 1;
            let secsLeft = 59 - turnSecsElapsed;

            if (minsLeft < 0) { minsLeft = 0; secsLeft = 0; } // Evitar negativos si se pasa

            document.getElementById('turn-timer').innerText = `${String(minsLeft).padStart(2,'0')}:${String(secsLeft).padStart(2,'0')}`;

            // Alarma de Giro
            if (minsLeft === 0 && secsLeft === 0) {
                document.getElementById('turn-timer').style.color = "var(--red)";
                document.getElementById('alarm-sound').play().catch(()=>{});
                if ("vibrate" in navigator) navigator.vibrate([500, 200, 500]);
            } else {
                document.getElementById('turn-timer').style.color = "var(--green)";
            }
        }

        function markTurn() {
            currentAngle = (currentAngle + 90) % 360;
            localStorage.setItem('otm_angle', currentAngle);
            document.getElementById('compass').style.transform = `rotate(${currentAngle}deg)`;
            document.getElementById('compass').innerText = `${currentAngle}°`;
            
            lastTurnTime = Date.now();
            localStorage.setItem('otm_last_turn', lastTurnTime);
            engineTick(); // Forzar actualización visual
        }

        // 4. PROCESAMIENTO DE DATOS
        function saveRecord() {
            const op = document.getElementById('in-op').value.trim();
            const punta = document.getElementById('in-punta').value.trim();
